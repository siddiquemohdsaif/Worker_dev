const LZ4_util = require('../../Utils/LZ4_util');
const axios = require('axios');


//const p = '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bnB8NAtHDI5YR1dISlZNTqMYHzS2CgAAvgUAZQcB4RAD6B4C9RMOcTQPLAkbArM6DywJAQB0AA8sCSAPDwMM8AB6UzgxcVNPUGRMVnJuYkvLCw+IAUs/cWxr4RAJgEdLQllSSFlQvSkKQAwPiAHL/wBUVUtuMldvMEp1cGxqV0emB09AZnZpZ7gND9keBI5NWExTWlpaSPETD4gBy/AAMGZQSTVHM2xIT0Mxb2xZFBUPEANLP3Brc98QCYBQVEtQTkFCSpkDDxAD2f8ATjl0YWFTeWVXQXNueTBhjhhPKnlmiEUNIAZuS1pRQVJalzoPEAPL/wBSSktNWEoyT2RrMmtqZ25lEk9PeXlleZgECI5RVk9KRldBUNUQD4gBGx0zPgwPqAcCD8YNBgKoBw8+DAEPqAdD/wFwbVVic3A0Q0lORk1Jc3ZkPgxOT2huYmuIAQiAVEdZTkVRTk1IMA+YBCkOERoPiAEhAHQBDE4PABQADzAJP/8AdTgyTGFKOXNyYWp6eDltIAZPMHpxch0LAOsSASYdC5gEjkpYSUtBUUVCOSAPEAMbD7gKnfAAR1dacDRRY0piRWV6YkJaqwIPqAdLMG1rZpwgD4gBBYBWVVZSWklVWecSDxADKQ+IAZ3/AWZLMHBzb2cxVG82Ym42SG+YBE4/dGxoIAYJgFVKS0RJV0dKQQsKiAEfMQ4aAQAlBA/JDbPwAG8zc0paNmIzOXFWWUNodB0jDxEDSzlqcGq5TgHiTgZmJp9SWE9TS0hNRU+JAd3wAGx5dUxNSldOMTVTTEhqdFQvD4kBSz9oeHdSDwmfT0xITUhXTU1RiQHd8ABpM2lUeE9jQ1RMaWFUZmEAAQ+JAUswbWZo7gEPIwYFj1VWV1RWWkxDGx0AD5sEy/AARGo1SzFSUDZCdUgzMHhSIwcPiQFLL3h1JAYKgEVHQU1WVk5Rn00PJAba8ABaT2FPRkZYZUhwWW91UE3cEQ+JAUs5cXhsKlALJAaASEhNWFlFVFlFIg+JAdrwAERPbnFDem9BZmpXWWpVYWokD4kBSz96eHoGPAmPUUFXU0FGVkY2Cd7wAHlMeWtlOUdGbkVZM1AzeFoKD4kBSyFoZxIIDyQGBYBTWlBZUFZJR5sDDxID2vAASWNwMTg0cVFocTVMUlRvAAEPiQFLMHRycO4BD4kBBXFHQ01VUk1Sm04PiQHa8ABFdmt5ZTY4MFRGOWFWN2ubBQ+JAUs/dndpSAwJgEtDTUJNU0tQeysKiQEPGTECD9ENt/AAdzY2YjdaMFJDS3NrYmEz4REPiQFLP2Nvc4kBCY5NUkRXT0ZVWQIXD4kBzP8AbkdRS1RENHoxM3ZLcXh6ixhPMGd6bdASD5sEBY5IV1JGUVhETb8KD4kBzPAAcEtyaURsNUQzN1E4WHBSfk8PEgNLOWJxdtw4C78KjkpNU0JOTUxLBBcPiQHM8ABGaFg3bUFNMnBQWFVtaWp7LQ+JAUs/anhrEgMJgFdLQUJNR0FHrQYPJAba4Vp4c0ZWNUZjbVBpZWk3skQPiQFLMHd2Zq0MD5sEBYBDR1FOVFBCQpsDCokBAH4VDo0vD64Ht/AAazVQb25IM2M3dWVXUWlxnAUPigFLMHViam0XD4oBBYBHRkhNWlRRUIkAD4oB2/AATHl6a0UzS0I3ZEJ1OFluSSQPigFLP2pyZSYGCYBFVFpSVEhERQheD4oBKw8sHRQPwzgGArQeAHQDDywdU/8AQ0RnM2hEYm94RTlSamhEtB5PP3N3eooBCYBCWEpERVJPQ10OD4oBKw+mG53/AG1oM2ZBU3FGYVZzRWhmYfUqTy96dc1aCo9JSFNSTVZBQR0aAw8oBsnwAEVWdWxkRWRWNm1jN2VxUUA4D54ESz9oZ2NAIAmOTE9JVk9QTVLECg+yB83/AEQ2RERBRWxCbUZ0WmwxVZYYTz93bGKyBwmPUkZRSUZRWUWEFQMPFAPJ8ABxckg0VFhZZnF6RWs5dFUyGA8UA0s/ZnRtzCEKYUxDT0FRSxMCDygGKw+yB53wAFdhTWFVdnRCcU92YUdLdesLD4oBSz9hYWgUAwmPUEZGVkRTRlaeBN/wAFZrUHNCMGd1TW5VSGxXQiUBD4oBSzB3bGoGVQ9QDAWOQkdUQllZQ1N4KQ8oBs3wAHprd0pvOUV5dE5JV1RUdHg6D4oBSz91Ym9HIAmPT1ZPWVpaQVHGCt//AElDajRNaWJRS2FveEN4b54ETz9qeXmcLwmPSkhDVUVGWEuyBwMN6z4AeQ0PbCYDD40snfAAT1hzWlYwaFZlMm5NUUJ22g4PEwNLMG1tZ2orD50EBZ1PSk9YRUtUUk6xBw8FKxsPrwed8ABZOTlTcjVnWWFpSjl1ME+zSg+IAUs5amZnIxqAVEtJR05NR1nHDARfTo5SS1NESFVBQ/dgDyoGHQ7iOw8cLhsCAkIPykwBAIsDDxwuIEBXYXIgCU4AiAINeEDwAGp0YTRTdVhjaUxrRmt3MygAD40BRRlXAQAIpi8PCEIBgE9WVFVWQU5H4gwKzwoPCEICABwBBacECatGD/dgAQ9bTiAD3TgQOFwxBO5PAHUAD5EBJACRBw+RAQLwAE05ZGxrRWVuODFXUkpzOblYD5EBRQLLeTBsa3ogMwCNAAHLeQ/RTAGOU0NLT09IR1VGHQAeAw80BhgfN8EyLAIPQgB4AQ8NFDQAHQMTMYwCDR0D8AB0MjhaNktISFhEcWpUOXi0AQ+MAUswendpNAsPjAEKjkFHU0pDT1lUwAcfNXEPGw/AB34PjAEK8ABmM2JZRHdsb211T0tkd3KzAg+MAUs5aHdoNgYLRx2dVFVPQ1lGUlFZoAQAEwMP+RAZDxQDfg99PQzwAFJDTmt2RW93MTFQRDhVd+McD4oBSz9kZGXRCgmATEVLQ0lMRFbPBwoqBg6GAQgmBgMMAAICPw/rcUcPJAYjD4QBDPAARFllWFhtbWs5YnBZRnJiLBUPhAFLKmNtxFoLDgOOWU5aUEdCUE+uBw+EARgOoBgAPAENZ1EfMGdRBRExe1QDOgkJSlwASAAPK0g+8ABWWHBta0RINWJEUG1KWm6AcQ+EAUswcmZwPg4FHgYLhAGOREJIQ0RBTEiSBA+EARgPCAOc/wFGUjgxZ1d4c1F2SDg5Z0I1yTVPM2p2eC8IAS4JC4QBjlFLR0lJUUxG1CEPhAHH/wF3VEdMVTZRZWNHUUU1Qnc2hAFOP3NlaIwECY5JRlJEUEVVSmsSD4QBx/8AWXo3eUVKN2I0VmpsbVNjjRhPP3d1YQgDCY5BWU5QT1ZVS1MjD4QByP8AamcxUkRPcjhkODZHdlByCANOP2tncUM3CY5WSEdHTkdGU2ASD4QBGA+UB5zwAFFDUGIzM00zNnNJV0xTQRhJD5QHSzBlZ3F9CQ+UBwWAR1VTU05CQVPQIw+cCtXwAFJISEx5a1o4aHA1ZjJsd0UND4QBS09nbG5nlAcIf1hJUE9ZUU8FGgAPCAMYDxgJnP8BeDJrbmxMdkJwWUdYaVhON4wETjlucmUXXwsYCY5aWklGSllCQYkbD4QBx/AAVWtFUkxjcTUyMXN1Y084sBEPCANLMG5jZfkHD4wEBX9UTVNFU01YYXkrDxAGnP8Ba0tBWGMxN1BidGhnWGVQOQgDTk9iZmdkjAQIf0RWRUdFSU2kDdrwAG9EMjM5VTc3cGd0NHBWVcsRDwgDSz9taGt4GwmATkVCS1FNSlN5Gg+UB9XwAGNpcFpDMmU5SmlJNE13Z8IoD4QBSz9ia3qsEAmOWUpVVlFBQ0ZvGw8QBhgPjASc8AAzVGVhNUozdVpXcmFVQW4uIQ+EAUs/ZWp2lAcJj09FQ1hIQktYKA/Z/wA5TlR4eGxqbWtydFpjanafOE8wcHBr8QQPlAcFnU5XQ1VET1VTRUYYDwgDGA+cCpzwAHZtSG1lMVFuZnJPUFdacCYnDwgDS09qaGhxlAcIgE5QUE5USUJLDQIPEAbV8AB4ZHZuY1pGdWpVdEd4cFKzCA+EAUs/Z3FinAoJn1hIRkxVTlhMRwgDy1AiOjB9XQ==';




const getTopPlayers = async () => {
    try {
        const response = await axios.post('https://function.cloudsw3.com/cc-app-api/seasonLeaderboardServer/get-top-players-fresh?from=1&to=500');
        return response.data;
    } catch (error) {
        console.error('Error calling getTopPlayers API:', error);
        throw new Error("error :" + error.message);
    }
}

const getTopClans = async () => {
    try {
        const response = await axios.post('https://function.cloudsw3.com/cc-app-api/seasonLeaderboardServer/get-top-clans-fresh?from=1&to=500');
        return response.data;
    } catch (error) {
        console.error('Error calling getTopClans API:', error);
        throw new Error("error :" + error.message);
    }
}


const giveRewardAndSetResult = async (topPlayersCompressString, topClansCompressString, rewardUids, rewardCids) => {
    const bodyData = {topPlayersCompressString, topClansCompressString, rewardUids, rewardCids}
    try {
        const response = await axios.post('https://function.cloudsw3.com/cc-app-api/seasonServer/give-rewards-and-set-result', bodyData);
        return response.data;
    } catch (error) {
        console.error('Error calling giveRewardAndSetResult API:', error);
        throw new Error("error :" + error.message);
    }
}



const makeResult = async() => {

    // //test decompression

    // const str_obj =  await LZ4_util.decompressString();
    // const obj = JSON.parse(str_obj);
    // console.log(obj);



    //get TopPlayers and topClans
    const topPlayerResponse = await getTopPlayers(); 
    const topClanResponse = await getTopClans(); 

    let topPlayerCommaIndex = topPlayerResponse.players.indexOf(',');
    const topPlayersCompressString = topPlayerResponse.players.substring(topPlayerCommaIndex + 1);

    let topClanCommaIndex = topClanResponse.clans.indexOf(',');
    const topClansCompressString = topClanResponse.clans.substring(topClanCommaIndex + 1);

    //console.log(topPlayersCompressString);
    //console.log(topClansCompressString);


    const topPlayers = JSON.parse(await LZ4_util.decompressString(topPlayersCompressString));
    const topClans = JSON.parse(await LZ4_util.decompressString(topClansCompressString));


    const rewardUids = topPlayers.map(player => player.uid);
    const rewardCids = topClans.map(clan => clan.clanId);

    await giveRewardAndSetResult(topPlayersCompressString, topClansCompressString, rewardUids, rewardCids);
}

module.exports = {
    makeResult
}











